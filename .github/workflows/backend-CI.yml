# workflowì˜ ì´ë¦„
name: Backend CI (Pull request)

# PR ìš”ì²­ì— ëŒ€í•´
on:
  pull_request:
    # íŠ¹ì • ë¸Œëœì¹˜ë§Œ
    branches:
      - develop # develop ë¸Œëœì¹˜ì—ì„œ pr ì´ë²¤íŠ¸ê°€ ì¼ì–´ë‚¬ì„ ë•Œ ì‹¤í–‰
    # prì´ ìƒì„± ë˜ì—ˆì„ ë•Œ, ë‹´ë‹¹ ìœ ì €ê°€ ë“±ë¡ë˜ì—ˆì„ ë•Œ, PRì— ì½”ë“œê°€ ë¨¸ì§€ë˜ì—ˆì„ ë•Œ, ë¼ë²¨ì´ ë‹¬ë ¸ì„ ë•Œ ë™ì‘
    types: [opened, assigned, synchronize, labeled, reopened]

jobs:
  ###### ë³¸ë¬¸ ë‚´ìš©ê³¼ ê´€ë ¨ ì—†ëŠ” Job, ë¹Œë“œ í…ŒìŠ¤íŠ¸
  test:
    env:
      # KEY - VALUE
      SONARQUBE_ID: jaksim31
      SONARQUBE_URL: ${{ secrets.SONARQUBE_URL }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
    # ubuntu í™˜ê²½ì—ì„œ ì‹¤í–‰ (í™˜ê²½ì€ githubì´ ì œê³µ)
    runs-on: macos-latest
    # ê° ë‹¨ê³„
    steps:
      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v2
        # ì„œë¸Œëª¨ë“ˆ ì„¤ì •
        with:
          submodules: true
          # secrets ë³€ìˆ˜ëŠ” github ì„¸íŒ…ì—ì„œ ë¯¸ë¦¬ ì„¸íŒ…í•œ ë°ì´í„°
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      - name: Install JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'

      # Maven Package Caching
      - name: Cache Maven packages
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Grant execute permission for maven
        run: chmod +x mvnw

      - name: Unit Test & Integration Test
        run: ./mvnw test -Dspring.profiles.active=local -P local

      - name: Write the testing result on PR
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always()
        with:
          files: '**/target/surefire-reports/TEST-*.xml'

      - name: Check Comment on the Code line.
        uses: mikepenz/action-junit-report@v3
        if: always()
        with:
          report_paths: '**/target/surefire-reports/TEST-*.xml'
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      # ìœ„ì—ì„œ ì„¤ì •í–ˆë˜ ì •ì ì½”ë“œ ì „ì†¡ íƒœìŠ¤í¬ ì‹¤í–‰
      - name: Sonaqube Analysis
        if: always()
        run: ./mvnw sonar:sonar -Dsonar.host.url=${{ env.SONARQUBE_URL }} -Dsonar.projectKey=${{ env.SONARQUBE_ID }} -Dsonar.projectName=${{ env.SONARQUBE_ID }}-${{ env.PR_NUMBER }} -Dsonar.login=${{ secrets.SONARQUBE_ACCESS_TOKEN }}

      - name: Comment Sonarqube URL
        if: always()
        uses: actions/github-script@v4
        with:
          # ì´ìŠˆì— ì½”ë©˜íŠ¸ë¥¼ ë‹¬ì•„ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          script: |
            const { SONARQUBE_ID, SONARQUBE_URL, PR_NUMBER } = process.env
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“Š ${ SONARQUBE_ID }-${ PR_NUMBER } ì •ì  ì½”ë“œ ë¶„ì„ ê²°ê³¼ í™•ì¸í•˜ê¸° [ë§í¬](${SONARQUBE_URL})`})