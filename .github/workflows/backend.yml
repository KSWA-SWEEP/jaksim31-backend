
# í•„ìš”í•œ Repo Secret ì„¤ì •
#### CI
# ${{ secrets.SONARQUBE_URL }} : ì†Œë‚˜íë¸Œ ì„œë²„ URL
# ${{ secrets.SONARQUBE_ACCESS_TOKEN }} : ì†Œë‚˜íë¸Œ ì—°ê²°ì„ ìœ„í•œ ì•¡ì„¸ìŠ¤ í† í°
# ${{ secrets.SUBMODULE_ACCESS_TOKEN }} : ê¹ƒí—ˆë¸Œ ì•¡ì„¸ìŠ¤ í† í°

#### CD
# ${{ secrets.DOCKER_ID }} : ë„ì»¤í—ˆë¸Œ id
# ${{ secrets.DOCKER_PASSWORD }} : ë„ì»¤í—ˆë¸Œ pw
# ${{ secrets.REMOTE_HOST }} : ë°°í¬ ì„œë²„ HOSTNAME
# ${{ secrets.REMOTE_PORT }} : ë°°í¬ ì„œë²„ PORT
# ${{ secrets.REMOTE_USERNAME }} : ë°°í¬ ì„œë²„ USERNAME
# ${{ secrets.REMOTE_SSH_KEY }} : ë°°í¬ ì„œë²„ ì—°ê²°ì„ ìœ„í•œ SSH KEY

name: Backend CI & CD

# PR ìš”ì²­ì— ëŒ€í•´
on:
  pull_request:
    # íŠ¹ì • ë¸Œëœì¹˜ë§Œ
    branches: [develop, main]
    # prì´ ìƒì„± ë˜ì—ˆì„ ë•Œ, ë‹´ë‹¹ ìœ ì €ê°€ ë“±ë¡ë˜ì—ˆì„ ë•Œ, PRì— ì½”ë“œê°€ ë¨¸ì§€ë˜ì—ˆì„ ë•Œ, ë¼ë²¨ì´ ë‹¬ë ¸ì„ ë•Œ ë™ì‘
    types: [opened, assigned, synchronize, labeled, reopened]
  push:
    branches: [develop, main]

jobs:
  ###### ë³¸ë¬¸ ë‚´ìš©ê³¼ ê´€ë ¨ ì—†ëŠ” Job, ë¹Œë“œ í…ŒìŠ¤íŠ¸
  Backend-CI:
    env:
      # KEY - VALUE
      SONARQUBE_ID: jaksim31
      SONARQUBE_URL: ${{ secrets.SONARQUBE_URL }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
    # macos í™˜ê²½ì—ì„œ CI ì‹¤í–‰ (í™˜ê²½ì€ githubì´ ì œê³µ)
    runs-on: macos-latest
    # ê° ë‹¨ê³„
    steps:

      # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v2
        # ì„œë¸Œëª¨ë“ˆ ì„¤ì •
        with:
          submodules: true
          # secrets ë³€ìˆ˜ëŠ” github ì„¸íŒ…ì—ì„œ ë¯¸ë¦¬ ì„¸íŒ…í•œ ë°ì´í„°
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      - name: Install JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'

      # Maven Package Caching
      - name: Cache Maven packages
        uses: actions/cache@v2
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Grant execute permission for maven
        run: chmod +x mvnw

      #      - name: check
      #        run : |
      #            cat submodule/resources/main/prod/application.yml

      # develop ë¸Œëœì¹˜ì¼ ê²½ìš° local í™˜ê²½ ë¹Œë“œ
      - name: (PR) Maven Build (Adding Unit Test & Integration Test)
        if: github.event_name == 'pull_request'
        run: ./mvnw clean install -Dspring.profiles.active=local -P local

      - name: (Push & Develop) Maven Build (Adding Unit Test & Integration Test)
        if: contains(github.ref, 'develop') && github.event_name == 'push'
        run: ./mvnw clean install -Dspring.profiles.active=local -P local

      # main ë¸Œëœì¹˜ì— push í•  ê²½ìš° prod í™˜ê²½ ë¹Œë“œ
      - name: (Push & Main) Maven Build (Skip Unit Test & Integration Test)
        if: contains(github.ref, 'main') && github.event_name == 'push'
        run: ./mvnw clean install -DskipTests=True -Dspring.profiles.active=prod -P prod

      # main ë¸Œëœì¹˜ì— push í•  ê²½ìš° CD jobì— jar file ì—…ë¡œë“œ
      - name: (Push & Main) Archive production artifacts
        if: github.event_name == 'push' && contains(github.ref, 'main')
        uses: actions/upload-artifact@v3
        with:
          name: target
          path: target/*.jar

      - name: (PR) Archive test results artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: test-result
          path: target/surefire-reports/

      - name: (PR) Archive test results artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v3
        with:
          name: classes
          path: target/classes/

  Report-Test-Result:
    if: github.event_name == 'pull_request'
    needs: Backend-CI
    # macos í™˜ê²½ì—ì„œ CI ì‹¤í–‰ (í™˜ê²½ì€ githubì´ ì œê³µ)
    runs-on: ubuntu-latest
    # ê° ë‹¨ê³„
    steps:
      # ì´ì „ Jobì—ì„œ ì—…ë¡œë“œí•œ Jar file ë‹¤ìš´ë¡œë“œ
      - name: Download a test result
        uses: actions/download-artifact@v1
        with:
          name: test-result

      - name: Write the testing result on PR
        uses: EnricoMi/publish-unit-test-result-action/composite@v2
        if: always() && github.event_name == 'pull_request'
        with:
          junit_files: '**/test-result/TEST-*.xml'
          comment_title: 'Jaksim31 Unit & Integration Test Results'
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      - name: Check Comment on the Code line.
        uses: mikepenz/action-junit-report@v3
        if: always() && github.event_name == 'pull_request'
        with:
          report_paths: '**/test-result/TEST-*.xml'
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}


  Sonarqube-Analysis:
    if: github.event_name == 'pull_request'
    needs: Backend-CI
    env:
      # KEY - VALUE
      SONARQUBE_ID: jaksim31
      SONARQUBE_URL: ${{ secrets.SONARQUBE_URL }}
      SONARQUBE_BINARIES: classes
      PR_NUMBER: ${{ github.event.pull_request.number }}
      # macos í™˜ê²½ì—ì„œ CI ì‹¤í–‰ (í™˜ê²½ì€ githubì´ ì œê³µ)
    runs-on: ubuntu-latest
    # ê° ë‹¨ê³„
    steps:
      # ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v2
        # ì„œë¸Œëª¨ë“ˆ ì„¤ì •
        with:
          submodules: true
          # secrets ë³€ìˆ˜ëŠ” github ì„¸íŒ…ì—ì„œ ë¯¸ë¦¬ ì„¸íŒ…í•œ ë°ì´í„°
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      # ì´ì „ Jobì—ì„œ ì—…ë¡œë“œí•œ Jar file ë‹¤ìš´ë¡œë“œ
      - name: Download a test result
        uses: actions/download-artifact@v1
        with:
          name: classes

      # ìœ„ì—ì„œ ì„¤ì •í–ˆë˜ ì •ì ì½”ë“œ ì „ì†¡ íƒœìŠ¤í¬ ì‹¤í–‰
      - name: Sonarqube Analysis
        if: always() && github.event_name == 'pull_request'
        run: ./mvnw sonar:sonar -Dsonar.java.binaries=${{ env.SONARQUBE_BINARIES }} -Dsonar.host.url=${{ env.SONARQUBE_URL }} -Dsonar.projectKey=${{ env.SONARQUBE_ID }} -Dsonar.projectName=${{ env.SONARQUBE_ID }}-${{ env.PR_NUMBER }} -Dsonar.login=${{ secrets.SONARQUBE_ACCESS_TOKEN }}

      - name: Comment Sonarqube URL
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v4
        with:
          # ì´ìŠˆì— ì½”ë©˜íŠ¸ë¥¼ ë‹¬ì•„ì£¼ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          script: |
            const { SONARQUBE_ID, SONARQUBE_URL, PR_NUMBER } = process.env
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ“Š ${ SONARQUBE_ID }-${ PR_NUMBER } ì •ì  ì½”ë“œ ë¶„ì„ ê²°ê³¼ í™•ì¸í•˜ê¸° [ë§í¬](${SONARQUBE_URL})`})

  Backend-CD:
    # main ë¸Œëœì¹˜ì— push í•˜ëŠ” ê²½ìš°ì—ë§Œ ë°°í¬ JOB ì‹¤í–‰
    if: github.event_name == 'push' && contains(github.ref, 'main')
    needs: Backend-CI
    runs-on: ubuntu-latest
    steps:

      # ì†ŒìŠ¤ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout source code
        uses: actions/checkout@v2
        # ì„œë¸Œëª¨ë“ˆ ì„¤ì •
        with:
          submodules: true
          # secrets ë³€ìˆ˜ëŠ” github ì„¸íŒ…ì—ì„œ ë¯¸ë¦¬ ì„¸íŒ…í•œ ë°ì´í„°
          token: ${{ secrets.SUBMODULE_ACCESS_TOKEN }}

      # ì´ì „ Jobì—ì„œ ì—…ë¡œë“œí•œ Jar file ë‹¤ìš´ë¡œë“œ
      - name : Download a built Jar File
        uses: actions/download-artifact@v1
        with:
          name: target

      # Docker Buildx Setting
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # Docker Login
      - name: Docker Login
        uses: docker/login-action@v2.1.0
        with:
          # Username used to log against the Docker registry
          username: ${{ secrets.DOCKER_ID }}
          # Password or personal access token used to log against the Docker registry
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Docker Build & Push
      - name: Docker Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ secrets.DOCKER_ID }}/jaksim31-backend:$(date +%s)
            ${{ secrets.DOCKER_ID }}/jaksim31-backend:latest
          cache-from: type=gha    # gha=Github Action Cache
          cache-to: type=gha,mode=max

      - name: Transfer Deploy Script use SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          port: ${{ secrets.REMOTE_PORT }}
          username: ${{ secrets.REMOTE_USERNAME }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          source: "scripts/deploy.sh"
          target: "/home/centos/deploy"

      # SSH Connect
      - name: Execute Server Init Script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          port: ${{ secrets.REMOTE_PORT }}
          username: ${{ secrets.REMOTE_USERNAME }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          script_stop: true
          script: chmod +x /home/centos/deploy/scripts/deploy.sh && sh /home/centos/deploy/scripts/deploy.sh

